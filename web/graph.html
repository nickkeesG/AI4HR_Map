<!DOCTYPE html>
<html>
<head>
    <title>Map of AI4HR</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'><path d='M152,128a24,24,0,1,1-24-24A24,24,0,0,1,152,128Z' opacity='0.2'/><path d='M200,152a31.84,31.84,0,0,0-19.53,6.68l-23.11-18A31.65,31.65,0,0,0,160,128c0-.74,0-1.48-.08-2.21l13.23-4.41A32,32,0,1,0,168,104c0,.74,0,1.48.08,2.21l-13.23,4.41A32,32,0,0,0,128,96a32.59,32.59,0,0,0-5.27.44L115.89,81A32,32,0,1,0,96,88a32.59,32.59,0,0,0,5.27-.44l6.84,15.4a31.92,31.92,0,0,0-8.57,39.64L73.83,165.44a32.06,32.06,0,1,0,10.63,12l25.71-22.84a31.91,31.91,0,0,0,37.36-1.24l23.11,18A31.65,31.65,0,0,0,168,184a32,32,0,1,0,32-32Zm0-64a16,16,0,1,1-16,16A16,16,0,0,1,200,88ZM80,56A16,16,0,1,1,96,72,16,16,0,0,1,80,56ZM56,208a16,16,0,1,1,16-16A16,16,0,0,1,56,208Zm56-80a16,16,0,1,1,16,16A16,16,0,0,1,112,128Zm88,72a16,16,0,1,1,16-16A16,16,0,0,1,200,200Z'/></svg>">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f4e8d0;
            --text-color: #333;
            --person-color: #69b3a2;
            --project-color: #d4791a;
            --organization-color: #9c4dcc;
            --topic-color: #3498db;
            --node-hover-color: #ff6b6b;
            --link-color: #999;
            --tooltip-bg: rgba(0, 0, 0, 0.8);
            --tooltip-text: white;
        }
        
        .dark-mode {
            --bg-color: #1a120a;
            --text-color: #e8d5b7;
            --person-color: #4ecdc4;
            --project-color: #f4a261;
            --organization-color: #ba68c8;
            --topic-color: #74b9ff;
            --node-hover-color: #ff8a80;
            --link-color: #666;
            --tooltip-bg: rgba(255, 255, 255, 0.9);
            --tooltip-text: #333;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        h1 {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            z-index: 1000;
            margin: 0;
            font-size: 24px;
        }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--text-color);
            color: var(--bg-color);
            cursor: pointer;
            font-size: 20px;
            z-index: 1001;
            transition: all 0.3s ease;
            line-height: 40px;
            text-align: center;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .feedback-button {
            position: absolute;
            top: 20px;
            right: 70px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--text-color);
            color: var(--bg-color);
            cursor: pointer;
            font-size: 20px;
            z-index: 1001;
            transition: all 0.3s ease;
            line-height: 40px;
            text-align: center;
        }
        
        .feedback-button:hover {
            transform: scale(1.1);
        }
        
        .help-button {
            position: absolute;
            top: 20px;
            right: 120px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--text-color);
            color: var(--bg-color);
            cursor: pointer;
            font-size: 20px;
            z-index: 1001;
            transition: all 0.3s ease;
            line-height: 40px;
            text-align: center;
        }
        
        .help-button:hover {
            transform: scale(1.1);
        }
        
        .search-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
        }
        
        .search-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .search-input {
            width: 300px;
            height: 40px;
            padding: 0 40px 0 15px;
            border: 2px solid var(--text-color);
            border-radius: 20px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 18px;
            cursor: pointer;
            opacity: 0.6;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .search-clear:hover {
            opacity: 1;
            background: var(--text-color);
            color: var(--bg-color);
        }
        
        .search-input::placeholder {
            color: var(--text-color);
            opacity: 0.6;
        }
        
        .search-input:focus {
            border-color: var(--project-color);
            box-shadow: 0 0 0 3px rgba(212, 121, 26, 0.2);
        }
        
        .search-results {
            margin-top: 5px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            font-weight: 500;
        }
        
        .topic-labels text {
            font-family: Arial, sans-serif;
            font-size: 50px;
            font-weight: normal;
            fill: var(--text-color);
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        .links line {
            stroke: var(--link-color);
            stroke-opacity: 0.6;
            stroke-width: 4;
        }
        
        .links line.topic-link {
            stroke: var(--link-color);
            stroke-opacity: 0.4;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        .nodes circle {
            cursor: pointer;
            transition: fill 0.3s ease;
        }
        
        .nodes circle:hover {
            fill: var(--node-hover-color);
        }

        .nodes circle.highlighted {
            fill: var(--node-hover-color);
            stroke: var(--text-color);
            stroke-width: 4px;
        }

        .links line.highlighted {
            stroke: var(--node-hover-color);
            stroke-opacity: 1;
            stroke-width: 6;
        }
        
        .tooltip {
            position: absolute;
            background: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 18px;
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--text-color);
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 36px;
            font-weight: bold;
            margin: 0;
        }

        .close {
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            line-height: 1.6;
            font-size: 18px;
        }

        .modal-body h1, .modal-body h2, .modal-body h3 {
            color: var(--text-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .modal-body a {
            color: var(--project-color);
            text-decoration: none;
        }

        .modal-body a:hover {
            text-decoration: underline;
        }

        .modal-body code {
            background-color: rgba(128, 128, 128, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .modal-body pre {
            background-color: rgba(128, 128, 128, 0.2);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <div class="search-wrapper">
            <input type="text" class="search-input" placeholder="Search nodes..." id="searchInput">
            <button class="search-clear" id="searchClear">&times;</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()"><span style="position: relative; top: -4px;">&#9789;</span></button>
    <button class="feedback-button" onclick="openFeedbackModal()"><span style="position: relative; top: -2px;">!</span></button>
    <button class="help-button" onclick="openHelpModal()"><span style="position: relative; top: -2px;">?</span></button>
    <div id="graph"></div>

    <!-- Content Modal -->
    <div id="contentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Feedback</h2>
                <span class="close" onclick="closeFeedbackModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form name="feedback" method="POST" data-netlify="true" netlify-honeypot="bot-field" onsubmit="handleFeedbackSubmit(event)">
                    <input type="hidden" name="form-name" value="feedback" />
                    <p style="display: none;"><input name="bot-field" /></p>
                    <div style="margin-bottom: 15px;">
                        <label for="feedback-message" style="display: block; margin-bottom: 5px; font-weight: bold;">Please tell me what I missed!</label>
                        <textarea id="feedback-message" name="message" placeholder="Thoughts, suggestions, issues..." required style="width: calc(100% - 22px); height: 120px; padding: 10px; border: 1px solid var(--text-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="feedback-email" style="display: block; margin-bottom: 5px; font-weight: bold;">Email (optional):</label>
                        <input type="email" id="feedback-email" name="email" placeholder="your@email.com" style="width: calc(100% - 22px); padding: 10px; border: 1px solid var(--text-color); border-radius: 4px; background-color: var(--bg-color); color: var(--text-color); font-family: inherit; box-sizing: border-box;" />
                    </div>
                    <button type="submit" style="background-color: var(--project-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">Send Feedback</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">About This Map</h2>
                <span class="close" onclick="closeHelpModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>This is an interactive map of the AI4HR space - exploring past attempts to apply AI to improving human reasoning, epistemics, or coordination (as well as some theoretical/conceptual discussions on the topic).</p>
                
                <h3>How to Navigate:</h3>
                <ul>
                    <li><strong>Click and drag</strong> to pan around the map</li>
                    <li><strong>Scroll</strong> to zoom in and out</li>
                    <li><strong>Hover over nodes</strong> to see connections</li>
                    <li><strong>Click on nodes</strong> to read more details</li>
                </ul>
                
                <h3>Node Types:</h3>
                <ul>
                    <li><span style="color: var(--person-color); font-weight: bold;">People</span></li>
                    <li><span style="color: var(--project-color); font-weight: bold;">Projects</span></li>
                    <li><span style="color: var(--organization-color); font-weight: bold;">Organizations</span></li>
                    <li><span style="color: var(--topic-color); font-weight: bold;">Topics</span></li>
                </ul>
                
                <p>Found something missing or incorrect? Use the <strong>!</strong> button to let me know!</p>
            </div>
        </div>
    </div>
    
    <script>
        // Set up dimensions to fill the window
        let width = window.innerWidth;
        let height = window.innerHeight;
        
        // Create SVG
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        
        // Add resize handler to update SVG dimensions
        function updateDimensions() {
            width = window.innerWidth;
            height = window.innerHeight;
            svg.attr("width", width).attr("height", height);
        }
        
        window.addEventListener('resize', updateDimensions);
        
        // Create container group for zoom/pan
        const container = svg.append("g");
        
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", function(event) {
                container.attr("transform", event.transform);
            });
        
        svg.call(zoom);
        
        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
        
        // Load the pre-computed data with positions - REQUIRED FILE
        d3.json("vault_data_with_positions.json").then(function(data) {
            // Validate that required position data exists
            if (!data || !data.nodes || data.nodes.length === 0) {
                throw new Error("vault_data_with_positions.json is missing or invalid");
            }
            
            // Verify all nodes have required position data
            const missingPositions = data.nodes.filter(node => 
                typeof node.x !== 'number' || typeof node.y !== 'number'
            );
            
            if (missingPositions.length > 0) {
                throw new Error(`${missingPositions.length} nodes missing position data in vault_data_with_positions.json`);
            }
            // Debug: Check the AI4Democracy node content
            const ai4DemocracyNode = data.nodes.find(n => n.id.includes("AI4Democracy"));
            if (ai4DemocracyNode) {
                console.log("AI4Democracy node found:", ai4DemocracyNode.title);
                console.log("AI4Democracy content:", ai4DemocracyNode.content);
                console.log("Content length:", ai4DemocracyNode.content.length);
                console.log("Content as JSON:", JSON.stringify(ai4DemocracyNode.content));
                console.log("Full node:", ai4DemocracyNode);
            }
            
            
            // Create links first so they appear behind nodes
            const link = container.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("class", d => d.type === "topic_link" ? "topic-link" : "");
            
            // Create nodes after links so they appear on top
            const node = container.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(data.nodes)
                .enter().append("circle")
                .attr("r", d => d.size || 8)
                .style("fill", d => {
                    if (d.tags.includes("person")) return "var(--person-color)";
                    if (d.tags.includes("project")) return "var(--project-color)";
                    if (d.tags.includes("organization")) return "var(--organization-color)";
                    if (d.tags.includes("topic")) return "var(--topic-color)";
                    return "var(--person-color)"; // default fallback
                });
            
            // Create labels for topic nodes only
            const topicNodes = data.nodes.filter(d => d.tags.includes("topic"));
            const labels = container.append("g")
                .attr("class", "topic-labels")
                .selectAll("text")
                .data(topicNodes)
                .enter().append("text")
                .text(d => d.title);
            
            // Since links already contain full objects, we need to map them to the actual nodes
            // from data.nodes to ensure they reference the same objects
            data.links.forEach(link => {
                link.source = data.nodes.find(node => node.id === link.source.id);
                link.target = data.nodes.find(node => node.id === link.target.id);
            });
            
            // Add event handlers to nodes
            node.on("mouseover", function(event, d) {
                    // Show tooltip
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(d.title)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    
                    // Highlight the hovered node
                    d3.select(this).classed("highlighted", true);
                    
                    // Find and highlight connected nodes and links
                    const connectedNodes = new Set();
                    
                    link.classed("highlighted", function(l) {
                        if (l.source === d || l.target === d) {
                            connectedNodes.add(l.source);
                            connectedNodes.add(l.target);
                            return true;
                        }
                        return false;
                    });
                    
                    // Highlight connected nodes
                    node.classed("highlighted", function(n) {
                        return connectedNodes.has(n);
                    });
                })
                .on("mouseout", function(d) {
                    // Hide tooltip
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    
                    // Remove all highlighting
                    node.classed("highlighted", false);
                    link.classed("highlighted", false);
                })
                .on("click", function(event, d) {
                    console.log('Clicked node:', d.title);
                    console.log('Node content:', d.content);
                    showModal(d.title, d.content);
                });
            
            // Set static positions directly from precomputed data
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            // Position topic labels below their nodes
            labels
                .attr("x", d => d.x)
                .attr("y", d => d.y + d.size + 40); // Position below node with more padding for larger text
            
            // Set up search functionality
            setupSearch(node, labels);
        });
        
        // Search functionality
        function setupSearch(nodeSelection, labelSelection) {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchClear = document.getElementById('searchClear');
            
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                let matchCount = 0;
                
                nodeSelection.style("opacity", d => {
                    if (!searchTerm) return 1; // Show all nodes if search is empty
                    
                    const titleMatch = d.title.toLowerCase().includes(searchTerm);
                    const contentMatch = d.content.toLowerCase().includes(searchTerm);
                    const isMatch = titleMatch || contentMatch;
                    
                    if (isMatch) matchCount++;
                    
                    return isMatch ? 1 : 0.1; // Highlight matches, dim others significantly
                });
                
                // Also dim/highlight topic labels to match their nodes
                if (labelSelection) {
                    labelSelection.style("opacity", d => {
                        if (!searchTerm) return 1;
                        
                        const titleMatch = d.title.toLowerCase().includes(searchTerm);
                        const contentMatch = d.content.toLowerCase().includes(searchTerm);
                        const isMatch = titleMatch || contentMatch;
                        
                        return isMatch ? 1 : 0.1;
                    });
                }
                
                // Update results count and clear button visibility
                if (!searchTerm) {
                    searchResults.textContent = '';
                    searchClear.style.display = 'none';
                } else {
                    searchResults.textContent = `${matchCount} result${matchCount !== 1 ? 's' : ''} found`;
                    searchClear.style.display = 'flex';
                }
            }
            
            // Search as user types
            searchInput.addEventListener('input', performSearch);
            
            function clearSearch() {
                searchInput.value = '';
                performSearch();
                searchInput.focus();
            }
            
            // Clear search button
            searchClear.addEventListener('click', clearSearch);
            
            // Clear search with Escape key
            searchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    clearSearch();
                }
            });
        }
        
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const toggle = document.querySelector('.theme-toggle');
            
            body.classList.toggle('dark-mode');
            
            // Update button icon
            if (body.classList.contains('dark-mode')) {
                toggle.innerHTML = '<span style="position: relative; top: 0px;">&#9788;</span>'; // Sun symbol
            } else {
                toggle.innerHTML = '<span style="position: relative; top: -4px;">&#9789;</span>'; // Moon symbol pushed up more
            }
        }

        // Configure marked to handle line breaks properly
        marked.setOptions({
            breaks: true,  // Convert single line breaks to <br>
            gfm: true      // Enable GitHub Flavored Markdown
        });

        // Modal functionality
        function showModal(title, content) {
            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = marked.parse(content);
            
            // Make all links open in new tabs
            const links = modalBody.querySelectorAll('a');
            links.forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
            
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('contentModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('contentModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeFeedbackModal();
                closeHelpModal();
            }
        });

        // Feedback modal functions
        function openFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.style.display = 'block';
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.style.display = 'none';
        }

        function handleFeedbackSubmit(event) {
            // Form will be handled by Netlify automatically
            // Show a simple confirmation and close modal after a brief delay
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.textContent = 'Sending...';
            submitButton.disabled = true;
            
            // Let Netlify handle the form submission naturally
            setTimeout(() => {
                closeFeedbackModal();
                // Reset form after closing
                setTimeout(() => {
                    event.target.reset();
                    submitButton.textContent = 'Send Feedback';
                    submitButton.disabled = false;
                }, 500);
            }, 1000);
        }

        // Help modal functions
        function openHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.style.display = 'block';
        }

        function closeHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.style.display = 'none';
        }

        // Close modals when clicking outside of them
        window.addEventListener('click', function(event) {
            const contentModal = document.getElementById('contentModal');
            const feedbackModal = document.getElementById('feedbackModal');
            const helpModal = document.getElementById('helpModal');
            
            if (event.target === contentModal) {
                closeModal();
            }
            if (event.target === feedbackModal) {
                closeFeedbackModal();
            }
            if (event.target === helpModal) {
                closeHelpModal();
            }
        });
    </script>
</body>
</html>
